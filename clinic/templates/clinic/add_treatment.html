{% extends 'base.html' %}
{% block title %}Add Treatment Record - Safar-Saathi{% endblock %}

{% block content %}

<div class="card mx-auto" style="max-width: 760px;">

  <!-- Header -->
  <div class="card-header py-2 d-flex justify-content-between align-items-center">
    <h6 class="mb-0">
      <i class="fas fa-notes-medical me-2"></i>
      Add Treatment & Prescription
    </h6>
    <a href="{% url 'clinic:clinic_dashboard' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left"></i>
    </a>
  </div>

  <!-- Body -->
  <div class="card-body p-3">
    <form method="post">
      {% csrf_token %}

      <!-- ================= Patient ================= -->
      <div class="mb-2">
        <label class="form-label small mb-1">Patient *</label>
        <select name="patient" class="form-select form-select-sm" required>
          <option value="">Select patient</option>
          {% for patient in patients %}
          <option value="{{ patient.id }}">
            {{ patient.user.get_full_name|default:patient.user.username }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- ================= Disease ================= -->
      <div class="mb-2">
        <label class="form-label small mb-1">Disease *</label>
        <input type="text"
               name="disease"
               class="form-control form-control-sm"
               value="HIV"
               required>
      </div>

      <!-- ================= Treatment ================= -->
      <div class="mb-3">
        <label class="form-label small mb-1">Treatment Details *</label>
        <textarea name="details"
                  class="form-control form-control-sm"
                  rows="3"
                  required
                  placeholder="Describe treatment details..."></textarea>
      </div>

      <hr class="my-3">

      <!-- ================= Prescription ================= -->
      <h6 class="small text-muted mb-2">
        <i class="fas fa-prescription me-1"></i>
        Prescription (Optional)
      </h6>

      <!-- Diagnosis -->
      <div class="mb-2">
        <label class="form-label small mb-1">Diagnosis</label>
        <textarea name="diagnosis"
                  class="form-control form-control-sm"
                  rows="2"
                  placeholder="Diagnosis details..."></textarea>
      </div>

      <!-- ================= Medications ================= -->
      <div id="medication-container">

        <div class="row g-2 medication-row mb-2">
          <div class="col-md-3">
            <input type="text"
                   name="medications[]"
                   class="form-control form-control-sm"
                   placeholder="Medicine name">
          </div>

          <div class="col-md-2">
            <input type="text"
                   name="dosages[]"
                   class="form-control form-control-sm"
                   placeholder="Dosage">
          </div>

          <div class="col-md-3">
            <input type="text"
                   name="frequencies[]"
                   class="form-control form-control-sm"
                   placeholder="e.g. twice daily">
          </div>

          <div class="col-md-3">
            <input type="text"
                   name="intake_times[]"
                   class="form-control form-control-sm"
                   placeholder="09:00, 21:00">
          </div>

          <div class="col-md-1 d-flex align-items-center">
            <button type="button"
                    class="btn btn-outline-danger btn-sm remove-medication">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

      </div>

      <button type="button"
              class="btn btn-outline-primary btn-sm mb-3"
              id="add-medication">
        <i class="fas fa-plus me-1"></i>
        Add Medicine
      </button>

      <!-- Instructions -->
      <div class="mb-2">
        <label class="form-label small mb-1">Instructions</label>
        <textarea name="instructions"
                  class="form-control form-control-sm"
                  rows="2"
                  placeholder="Additional instructions..."></textarea>
      </div>

      <!-- Start / End Dates -->
      <div class="row g-2 mb-3">
        <div class="col-md-6">
          <label class="form-label small mb-1">Start Date</label>
          <input type="date"
                 name="start_date"
                 class="form-control form-control-sm">
        </div>
        <div class="col-md-6">
          <label class="form-label small mb-1">End Date</label>
          <input type="date"
                 name="end_date"
                 class="form-control form-control-sm">
        </div>
      </div>

      <!-- Actions -->
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="fas fa-save me-1"></i>
          Save
        </button>
        <a href="{% url 'clinic:clinic_dashboard' %}"
           class="btn btn-outline-secondary btn-sm">
          Cancel
        </a>
      </div>

    </form>
  </div>
</div>

<!-- ================= JavaScript ================= -->
<script>
document.getElementById('add-medication').addEventListener('click', function () {
  const container = document.getElementById('medication-container');

  const row = document.createElement('div');
  row.className = 'row g-2 medication-row mb-2';

  row.innerHTML = `
    <div class="col-md-3">
      <input type="text" name="medications[]" class="form-control form-control-sm" placeholder="Medicine name">
    </div>
    <div class="col-md-2">
      <input type="text" name="dosages[]" class="form-control form-control-sm" placeholder="Dosage">
    </div>
    <div class="col-md-3">
      <input type="text" name="frequencies[]" class="form-control form-control-sm" placeholder="e.g. twice daily">
    </div>
    <div class="col-md-3">
      <input type="text" name="intake_times[]" class="form-control form-control-sm" placeholder="09:00, 21:00">
    </div>
    <div class="col-md-1 d-flex align-items-center">
      <button type="button" class="btn btn-outline-danger btn-sm remove-medication">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;

  container.appendChild(row);
});

document.addEventListener('click', function (e) {
  if (e.target.closest('.remove-medication')) {
    e.target.closest('.medication-row').remove();
  }
});
</script>

{% endblock %}
