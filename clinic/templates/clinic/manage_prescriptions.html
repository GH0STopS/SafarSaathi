{% extends 'base.html' %}

{% block title %}Manage Prescriptions - Safar-Saathi{% endblock %}

{% block content %}

<div class="card">
  <!-- Header -->
  <div class="card-header py-2 d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="fas fa-prescription-bottle me-2"></i>Prescriptions
    </h5>
    <a href="{% url 'clinic:clinic_dashboard' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left me-1"></i>Back
    </a>
  </div>

  <!-- Body -->
  <div class="card-body p-3">

    {% for prescription in prescriptions %}
    <div class="border rounded p-3 mb-2 bg-light">

      <!-- Top row -->
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <strong class="small">
            {{ prescription.patient.user.get_full_name|default:prescription.patient.user.username }}
          </strong>
          <div class="small text-muted">
            {{ prescription.prescription_date|date:"M d, Y" }} ·
            Dr. {{ prescription.doctor.get_full_name|default:prescription.doctor.username }}
          </div>
        </div>

        <span class="badge bg-{% if prescription.is_active %}success{% else %}secondary{% endif %}">
          {% if prescription.is_active %}Active{% else %}Completed{% endif %}
        </span>
      </div>

      <!-- Diagnosis -->
      <div class="mt-2 small">
        <strong>Diagnosis:</strong> {{ prescription.diagnosis }}
      </div>

      <!-- Medications -->
      <div class="mt-2">
        <strong class="small">Medications:</strong>
        {% if prescription.medications %}
          <ul class="small mb-1 ps-3">
            {% for med in prescription.medications %}
              <li>{{ med.name }} — {{ med.dosage }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="small text-muted">No medications listed</div>
        {% endif %}
      </div>

      <!-- Actions -->
      <div class="text-end mt-2">
        <button
          class="btn btn-sm btn-outline-primary"
          data-bs-toggle="modal"
          data-bs-target="#updateModal{{ prescription.id }}"
        >
          <i class="fas fa-edit me-1"></i>Update
        </button>
      </div>
    </div>

    <!-- Update Modal -->
    <div class="modal fade" id="updateModal{{ prescription.id }}" tabindex="-1">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h6 class="modal-title mb-0">Update Prescription</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <form method="post" action="{% url 'clinic:update_prescription' prescription.id %}">
            {% csrf_token %}
            <div class="modal-body p-3">
              <label class="form-label small mb-1">Status</label>
              <select name="status" class="form-select form-select-sm" required>
                <option value="active" {% if prescription.is_active %}selected{% endif %}>
                  Active
                </option>
                <option value="completed" {% if not prescription.is_active %}selected{% endif %}>
                  Completed
                </option>
              </select>
            </div>
            <div class="modal-footer py-2">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary btn-sm">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% empty %}
    <div class="text-center py-4 text-muted">
      <i class="fas fa-pills fa-2x mb-2 opacity-25"></i>
      <div>No prescriptions found</div>
    </div>
    {% endfor %}

  </div>
</div>

{% endblock %}
