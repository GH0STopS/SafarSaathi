{% extends 'base.html' %}

{% block title %}Manage Counselling Sessions - Safar-Saathi{% endblock %}

{% block content %}
<div class="card">

  <!-- Header -->
  <div class="card-header py-2 d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
      <i class="fas fa-user-friends me-2"></i>
      Counselling Sessions
    </h5>
    <div class="d-flex gap-2">
      <a href="{% url 'clinic:schedule_counselling' %}" class="btn btn-primary btn-sm">
        <i class="fas fa-plus me-1"></i>New
      </a>
      <a href="{% url 'clinic:clinic_dashboard' %}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-arrow-left me-1"></i>Back
      </a>
    </div>
  </div>

  <!-- Table -->
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="px-3 py-2">Patient</th>
            <th class="px-3 py-2">Date</th>
            <th class="px-3 py-2">Counsellor</th>
            <th class="px-3 py-2">Type</th>
            <th class="px-3 py-2">Status</th>
            <th class="px-3 py-2 text-end">Actions</th>
          </tr>
        </thead>
        <tbody>

          {% for session in sessions %}
          <tr>
            <!-- Patient -->
            <td class="px-3 py-2">
              <strong class="small">
                {{ session.patient.user.get_full_name|default:session.patient.user.username }}
              </strong>
            </td>

            <!-- Date -->
            <td class="px-3 py-2">
              <small>{{ session.session_date|date:"M d, Y Â· H:i" }}</small>
            </td>

            <!-- Counsellor -->
            <td class="px-3 py-2">
              <small>
                {{ session.counsellor.get_full_name|default:session.counsellor.username }}
              </small>
            </td>

            <!-- Type -->
            <td class="px-3 py-2">
              <small>{{ session.get_session_type_display }}</small>
            </td>

            <!-- Status -->
            <td class="px-3 py-2">
              <span class="badge bg-{% if session.status == 'completed' %}success{% elif session.status == 'scheduled' %}primary{% elif session.status == 'in_progress' %}warning{% else %}danger{% endif %}">
                {{ session.status|title }}
              </span>
            </td>

            <!-- Actions -->
            <td class="px-3 py-2 text-end">
              <button
                class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#updateModal{{ session.id }}"
              >
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>

          <!-- Update Modal -->
          <div class="modal fade" id="updateModal{{ session.id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">

                <div class="modal-header py-2">
                  <h6 class="modal-title mb-0">Update Counselling Session</h6>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <form method="post" action="{% url 'clinic:update_counselling_session' session.id %}">
                  {% csrf_token %}

                  <div class="modal-body p-3">

                    <!-- Status -->
                    <div class="mb-2">
                      <label class="form-label small mb-1">Status</label>
                      <select class="form-select form-select-sm" name="status" required>
                        <option value="scheduled" {% if session.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="in_progress" {% if session.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if session.status == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if session.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                      </select>
                    </div>

                    <!-- Medical Updates -->
                    <div class="mb-2">
                      <label class="form-label small mb-1">Medical Updates</label>
                      <textarea
                        class="form-control form-control-sm"
                        name="medical_updates"
                        rows="2"
                      >{{ session.medical_updates }}</textarea>
                    </div>

                    <!-- Notes -->
                    <div class="mb-2">
                      <label class="form-label small mb-1">Session Notes</label>
                      <textarea
                        class="form-control form-control-sm"
                        name="notes"
                        rows="2"
                      >{{ session.notes }}</textarea>
                    </div>

                    <!-- Follow Up -->
                    <div class="form-check mb-2">
                      <input
                        type="checkbox"
                        class="form-check-input"
                        id="follow_up{{ session.id }}"
                        name="follow_up_required"
                        {% if session.follow_up_required %}checked{% endif %}
                      >
                      <label class="form-check-label small" for="follow_up{{ session.id }}">
                        Follow-up Required
                      </label>
                    </div>

                    <div
                      id="follow_up_date_div{{ session.id }}"
                      {% if not session.follow_up_required %}style="display:none"{% endif %}
                    >
                      <label class="form-label small mb-1">Follow-up Date</label>
                      <input
                        type="datetime-local"
                        class="form-control form-control-sm"
                        name="follow_up_date"
                        value="{% if session.follow_up_date %}{{ session.follow_up_date|date:'Y-m-d\\TH:i' }}{% endif %}"
                      >
                    </div>

                  </div>

                  <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                      Close
                    </button>
                    <button type="submit" class="btn btn-primary btn-sm">
                      Update
                    </button>
                  </div>

                </form>
              </div>
            </div>
          </div>

          {% empty %}
          <tr>
            <td colspan="6" class="text-center py-4 text-muted">
              <i class="fas fa-user-friends fa-2x mb-2 d-block opacity-25"></i>
              <small>No counselling sessions found</small>
            </td>
          </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  {% for session in sessions %}
  const checkbox{{ session.id }} = document.getElementById('follow_up{{ session.id }}');
  const div{{ session.id }} = document.getElementById('follow_up_date_div{{ session.id }}');
  if (checkbox{{ session.id }}) {
    checkbox{{ session.id }}.addEventListener('change', function () {
      div{{ session.id }}.style.display = this.checked ? 'block' : 'none';
    });
  }
  {% endfor %}
});
</script>

{% endblock %}
