{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Respond to Emergency - Safar-Saathi{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-reply text-danger me-2"></i>Respond to Emergency Alert</h2>
            <a href="{% url 'emergency:emergency_alerts' %}" class="btn btn-secondary mb-3"><i class="fas fa-arrow-left me-2"></i>Back to Alerts</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Emergency Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Patient:</strong> {{ alert.patient.user.get_full_name|default:alert.patient.user.username }}</p>
                            <p><strong>Alert Type:</strong> {{ alert.alert_type|title|replace:"_":" " }}</p>
                            <p><strong>Triggered:</strong> {{ alert.triggered_at }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Status:</strong>
                                <span class="badge bg-{% if alert.resolution_status == 'pending' %}warning{% elif alert.resolution_status == 'responding' %}info{% elif alert.resolution_status == 'resolved' %}success{% else %}secondary{% endif %}">
                                    {{ alert.resolution_status|title }}
                                </span>
                            </p>
                            {% if alert.location_address %}
                            <p><strong>Location:</strong> {{ alert.location_address }}</p>
                            {% endif %}
                            {% if is_nearby_response %}
                            <p><strong>Home Clinic:</strong> {{ alert.patient.current_clinic.name }}</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-3">
                        <strong>Alert Message:</strong>
                        <div class="alert alert-danger mt-2">
                            {{ alert.alert_message }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h5><i class="fas fa-edit me-2"></i>Response Form</h5>
                </div>
                <div class="card-body">
                    {% if is_nearby_response %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Important:</strong> This is a nearby patient from {{ alert.patient.current_clinic.name }}.
                        Responding to this emergency will automatically request critical medical data from their home clinic.
                    </div>
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="resolution_status" class="form-label">Response Status</label>
                            <select class="form-control" id="resolution_status" name="resolution_status" required>
                                <option value="responding">Responding</option>
                                <option value="resolved">Resolved</option>
                                <option value="false_alarm">False Alarm</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="resolution_notes" class="form-label">Response Notes</label>
                            <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="4" placeholder="Describe the response actions taken, treatment provided, and any follow-up required..." required></textarea>
                        </div>
                        <div class="text-end">
                            <a href="{% url 'emergency:emergency_alerts' %}" class="btn btn-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-paper-plane me-2"></i>Submit Response
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}