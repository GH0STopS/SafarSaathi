{% extends 'base.html' %}

{% block title %}
Dashboard - Safar-Saathi
{% endblock %}

{% block content %}


<!-- Header -->
<div class="card mb-3">
  <div
    class="card-body card-blue py-3 d-flex justify-content-between align-items-center"
  >
    <div>
      <h4 class="mb-1">
        <i class="fas fa-user-circle me-2 text-primary"></i>
        Welcome, {{ patient.user.get_full_name }}
      </h4>
      <small class="text-muted">
        <i class="fas fa-map-marker-alt me-1"></i>
        {{ patient.current_location }}
      </small>
    </div>
  </div>
</div>

<!-- Treatment + Health Overview -->
<div class="row g-3">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header py-2">
        <strong
          ><i class="fas fa-notes-medical me-1"></i> Treatment Records</strong
        >
      </div>
      <div class="card-body py-2">
        {% for record in treatment_records %}
        <div class="border rounded p-2 mb-2 bg-light">
          <small class="fw-bold">{{ record.record_date }}</small>
          <div class="small">{{ record.details }}</div>
        </div>
        {% empty %}
        <p class="text-muted small mb-0">No treatment records yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header py-2">
        <strong><i class="fas fa-chart-line me-1"></i> Health Overview</strong>
      </div>
      <div class="card-body py-3">
        <div class="row text-center">
          <div class="col-6">
            <h4 class="mb-0">{{ adherence_percentage }}%</h4>
            <small class="text-muted">Adherence</small>
            <div class="progress mt-1" style="height: 6px">
              <div
                class="progress-bar bg-{% if adherence_percentage >= 80 %}success{% elif adherence_percentage >= 60 %}warning{% else %}danger{% endif %}"
                style="width: {{ adherence_percentage }}%"
              ></div>
            </div>
          </div>
          <div class="col-6">
            <h4 class="mb-0">{{ upcoming_appointments|length }}</h4>
            <small class="text-muted">Appointments</small><br />
            <i class="fas fa-calendar-check text-info mt-1"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Appointments + Prescriptions -->
<div class="row g-3 mt-1">
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header py-2">
        <strong
          ><i class="fas fa-calendar-alt me-1"></i> Upcoming
          Appointments</strong
        >
      </div>
      <div class="card-body py-2">
        {% for appointment in upcoming_appointments %}
        <div class="border rounded p-2 mb-2 bg-light">
          <small class="fw-bold">
            {{ appointment.appointment_date|date:"M d, Y H:i" }}
          </small>
          <div class="small">
            {{ appointment.get_appointment_type_display }} – {{appointment.clinic.name }}
          </div>
          <span class="badge bg-info"
            >{{ appointment.get_consultation_mode_display }}</span
          >
          <span
            class="badge bg-{% if appointment.status == 'confirmed' %}success{% else %}warning{% endif %}"
          >
            {{ appointment.status }}
          </span>
        </div>
        {% empty %}
        <p class="text-muted small mb-0">No upcoming appointments.</p>
        {% endfor %}
        <a
          href="{% url 'patient:my_appointments' %}"
          class="btn btn-sm btn-outline-primary mt-1"
        >
          View All
        </a>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header py-2">
        <strong
          ><i class="fas fa-prescription me-1"></i> Today's Medication</strong
        >
      </div>
      <div class="card-body py-2">
        {% for medication in medications %}
        <div class="border rounded p-2 mb-2 bg-light">
          <div class="row align-items-center">
            <!-- LEFT : Medication Info -->
            <div class="col-8">
              <div class="fw-semibold small">
                {{ medication.reminder.medication_name }}
              </div>
              <div class="small text-muted">
                {{ medication.reminder.dosage }} · {{medication.reminder.frequency }}
              </div>
              <div class="small text-muted">
                <i class="fas fa-clock me-1"></i>
                {{ medication.intake_time }}
              </div>
            </div>

            <!-- RIGHT : Status -->
            <div class="col-4 text-end">
              {% if medication.has_taken %}
              <span class="badge bg-success">Taken</span>
              {% else %}
              <span class="badge bg-warning text-dark">Pending</span>
              <form method="post" action="{% url 'patient:mark_medication_taken' medication.id %}" class="mt-1">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-success mt-1">
                  Mark as Taken
                </button>
              </form>
              {% endif %}
            </div>
          </div>
        </div>
        {% empty %}
        <p class="text-muted small mb-0">No active prescriptions.</p>
        {% endfor %}

        <a
          href="{% url 'patient:my_prescriptions' %}"
          class="btn btn-sm btn-outline-success mt-2"
        >
          View All
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Primary Actions -->
<div class="row g-2 mt-3">
  <div class="col-md-3 col-6">
    <a
      href="{% url 'patient:book_appointment' %}"
      class="btn btn-success w-100 py-3"
    >
      <i class="fas fa-calendar-plus d-block mb-1"></i>
      Book Appointment
    </a>
  </div>
  <div class="col-md-3 col-6">
    <a
      href="{% url 'patient:my_appointments' %}"
      class="btn btn-info w-100 py-3"
    >
      <i class="fas fa-calendar-check d-block mb-1"></i>
      Appointments
    </a>
  </div>
  <div class="col-md-3 col-6">
    <a
      href="{% url 'patient:my_counselling_sessions' %}"
      class="btn btn-warning w-100 py-3"
    >
      <i class="fas fa-user-friends d-block mb-1"></i>
      Counselling
    </a>
  </div>
  <div class="col-md-3 col-6">
    <a
      href="{% url 'patient:emergency_trigger' %}"
      class="btn btn-danger w-100 py-3"
    >
      <i class="fas fa-exclamation-triangle d-block mb-1"></i>
      Emergency
    </a>
  </div>
</div>

<!-- Secondary Actions -->
<div class="row g-2 mt-2">
  <div class="col-md-2 col-6">
    <a
      href="{% url 'patient:external_consultations' %}"
      class="btn btn-outline-primary w-100"
      >External</a
    >
  </div>
  <div class="col-md-2 col-6">
    <a
      href="{% url 'patient:telemedicine_sessions' %}"
      class="btn btn-outline-success w-100"
      >Telemedicine</a
    >
  </div>
  <div class="col-md-2 col-6">
    <a
      href="{% url 'patient:my_prescriptions' %}"
      class="btn btn-outline-info w-100"
      >Prescriptions</a
    >
  </div>
  <div class="col-md-2 col-6">
    <a
      href="{% url 'patient:health_metrics' %}"
      class="btn btn-outline-warning w-100"
      >Metrics</a
    >
  </div>
  <div class="col-md-2 col-6">
    <a
      href="{% url 'patient:notifications' %}"
      class="btn btn-outline-danger w-100"
    >
      Notifications{% if unread_count %} ({{ unread_count }}){% endif %}
    </a>
  </div>
  <div class="col-md-2 col-6">
    <a
      href="{% url 'patient:nearby_clinics' %}"
      class="btn btn-outline-secondary w-100"
    >
      Clinics
    </a>
  </div>
</div>

{% endblock %}
