{% extends 'base.html' %}
{% block title %}Book External Consultation{% endblock %}

{% block content %}
<div class="container py-3">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="fas fa-globe me-2"></i>External Consultation</h4>
    <a href="{% url 'patient:external_consultations' %}" class="btn btn-outline-secondary btn-sm">
      <i class="fas fa-arrow-left"></i>
    </a>
  </div>

  <div class="row g-3">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body p-3">
          <form method="post">
            {% csrf_token %}

            <div class="mb-2">
              <label class="form-label">Clinic</label>
              <select class="form-select" name="clinic_id" required>
                <option value="">Select clinic</option>
                {% for clinic in disease_clinics %}
                  <option value="{{ clinic.id }}">{{ clinic.name }} - {{ clinic.location }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Preferred Date & Time</label>
              <input type="datetime-local" class="form-control" name="consultation_date" required>
            </div>

            <input type="hidden" name="current_location" id="current_location">


            <div class="mb-2">
              <label class="form-label">Consultation Type</label>
              <select class="form-select" name="consultation_type" required>
                <option value="specialist_consultation">Specialist</option>
                <option value="emergency_care">Emergency</option>
                <option value="follow_up">Follow-up</option>
              </select>
            </div>

            <div class="mb-2">
              <label class="form-label">Reason</label>
              <textarea class="form-control" rows="2" name="reason" required></textarea>
            </div>

            <div class="mb-2">
              <label class="form-label">Stay Type</label>
              <select class="form-select" name="stay_type" required>
                <option value="temporary">Temporary</option>
                <option value="permanent">Permanent</option>
              </select>
            </div>

            <button class="btn btn-primary w-100 mt-2">Submit Request</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-body p-3">
          <h6>Data Access</h6>
          <small class="text-muted">
            Temporary = limited access<br>
            Permanent = full access
          </small>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function (position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
          .then(res => res.json())
          .then(data => {
            if (data && data.display_name) {
              document.getElementById('current_location').value = data.display_name;
            }
          });
      },
      function () {
        console.warn("Location access denied");
      }
    );
  }
});
</script>
{% endblock %}
