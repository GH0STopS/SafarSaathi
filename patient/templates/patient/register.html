{% extends 'base.html' %} {% block title %}Register - Safar-Saathi{% endblock %}
{% block content %}
<div class="container py-3">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-12">
      <div class="card shadow-sm">
        <div class="card-header py-2 text-center">
          <h5 class="mb-0">
            <i class="fas fa-user-plus me-1"></i> Patient Registration
          </h5>
        </div>

        <div class="card-body p-3">
          <div id="alert-container"></div>

          <form method="post">
            {% csrf_token %} {% if form.non_field_errors %}
            <div class="alert alert-danger py-2 mb-2">
              <ul class="mb-0 small">
                {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- Username & Email -->
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label small"
                  >{{ form.username.label }}</label
                >
                {{ form.username }}
                <div id="username-error" class="text-danger small d-none"></div>
                <div id="username-success" class="text-success small d-none">
                  <i class="fas fa-check"></i> Looks good
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label small">{{ form.email.label }}</label>
                {{ form.email }}
                <div id="email-error" class="text-danger small d-none"></div>
                <div id="email-success" class="text-success small d-none">
                  <i class="fas fa-check"></i> Looks good
                </div>
              </div>
            </div>

            <!-- Name -->
            <div class="row g-2 mt-1">
              <div class="col-md-6">
                <label class="form-label small"
                  >{{ form.first_name.label }}</label
                >
                {{ form.first_name }}
                <div
                  id="first-name-error"
                  class="text-danger small d-none"
                ></div>
              </div>

              <div class="col-md-6">
                <label class="form-label small"
                  >{{ form.last_name.label }}</label
                >
                {{ form.last_name }}
                <div
                  id="last-name-error"
                  class="text-danger small d-none"
                ></div>
              </div>
            </div>

            <!-- Password -->
            <div class="row g-2 mt-1">
              <div class="col-md-6">
                <label class="form-label small"
                  >{{ form.password.label }}</label
                >
                {{ form.password }}
                <div id="password-error" class="text-danger small d-none"></div>
              </div>

              <div class="col-md-6">
                <label class="form-label small"
                  >{{ form.confirm_password.label }}</label
                >
                {{ form.confirm_password }}
                <div
                  id="confirm-password-error"
                  class="text-danger small d-none"
                ></div>
              </div>
            </div>

            <!-- DOB & Phone -->
            <div class="row g-2 mt-1">
              <div class="col-md-6">
                <label class="form-label small"
                  >{{ form.date_of_birth.label }}</label
                >
                {{ form.date_of_birth }}
                <div
                  id="date-of-birth-error"
                  class="text-danger small d-none"
                ></div>
              </div>

              <div class="col-md-6">
                <label class="form-label small"
                  >{{ form.phone_number.label }}</label
                >
                {{ form.phone_number }}
                <div
                  id="phone-number-error"
                  class="text-danger small d-none"
                ></div>
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label small">
                <i class="fas fa-hospital me-1"></i>
                Treatment Clinic
              </label>
              {{ form.current_clinic }} {% if form.current_clinic.errors %}
              <div class="text-danger small">
                {{ form.current_clinic.errors|striptags }}
              </div>
              {% endif %}
            </div>

            <!-- Address -->
            <div class="mt-1">
              <label class="form-label small">{{ form.address.label }}</label>
              {{ form.address }}
              <div id="address-error" class="text-danger small d-none"></div>

              <button
                type="button"
                id="get-location-btn"
                class="btn btn-outline-secondary btn-sm mt-1"
              >
                <i class="fas fa-location-arrow"></i> Use Current Location
              </button>
            </div>

            <!-- Current Location -->
            <div class="mt-2">
              <label class="form-label small"
                >{{ form.current_location.label }}</label
              >
              {{ form.current_location }}
              <div
                id="current-location-error"
                class="text-danger small d-none"
              ></div>
            </div>

            <!-- Consent -->
            <div class="form-check mt-2">
              {{ form.consent_given }}
              <label
                class="form-check-label small"
                for="{{ form.consent_given.id_for_label }}"
              >
                I consent to data processing for treatment continuity
              </label>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-primary w-100 mt-3">
              <i class="fas fa-user-plus me-1"></i> Register
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<style>
  .is-invalid {
    border-color: #dc3545;
  }
  .is-valid {
    border-color: #28a745;
  }
  .text-danger {
    color: #dc3545;
  }
  .text-success {
    color: #28a745;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Alert system
    function showAlert(message, type = "danger") {
      const alertContainer = document.getElementById("alert-container");
      if (!alertContainer) return;

      const alertClass =
        type === "success"
          ? "alert-success"
          : type === "warning"
            ? "alert-warning"
            : "alert-danger";
      alertContainer.innerHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    // Form fields configuration
    const fields = {
      username: {
        element: document.getElementById("{{ form.username.id_for_label }}"),
        errorElement: document.getElementById("username-error"),
        successElement: document.getElementById("username-success"),
      },
      email: {
        element: document.getElementById("{{ form.email.id_for_label }}"),
        errorElement: document.getElementById("email-error"),
        successElement: document.getElementById("email-success"),
      },
      password: {
        element: document.getElementById("{{ form.password.id_for_label }}"),
        errorElement: document.getElementById("password-error"),
        successElement: document.getElementById("password-success"),
      },
      confirm_password: {
        element: document.getElementById(
          "{{ form.confirm_password.id_for_label }}"
        ),
        errorElement: document.getElementById("confirm-password-error"),
        successElement: document.getElementById("confirm-password-success"),
      },
      first_name: {
        element: document.getElementById("{{ form.first_name.id_for_label }}"),
        errorElement: document.getElementById("first-name-error"),
        successElement: document.getElementById("first-name-success"),
      },
      last_name: {
        element: document.getElementById("{{ form.last_name.id_for_label }}"),
        errorElement: document.getElementById("last-name-error"),
        successElement: document.getElementById("last-name-success"),
      },
      date_of_birth: {
        element: document.getElementById(
          "{{ form.date_of_birth.id_for_label }}"
        ),
        errorElement: document.getElementById("date-of-birth-error"),
        successElement: document.getElementById("date-of-birth-success"),
      },
      phone_number: {
        element: document.getElementById(
          "{{ form.phone_number.id_for_label }}"
        ),
        errorElement: document.getElementById("phone-number-error"),
        successElement: document.getElementById("phone-number-success"),
      },
      address: {
        element: document.getElementById("{{ form.address.id_for_label }}"),
        errorElement: document.getElementById("address-error"),
        successElement: document.getElementById("address-success"),
      },
      current_location: {
        element: document.getElementById(
          "{{ form.current_location.id_for_label }}"
        ),
        errorElement: document.getElementById("current-location-error"),
        successElement: document.getElementById("current-location-success"),
      },
    };

    // Utility functions
    function setFieldError(fieldName, error) {
      const field = fields[fieldName];
      if (!field) return;

      field.element.classList.remove("is-valid");
      field.element.classList.add("is-invalid");

      if (field.errorElement) {
        field.errorElement.textContent = error;
        field.errorElement.style.display = "block";
      }
      if (field.successElement) {
        field.successElement.style.display = "none";
      }
    }

    function setFieldSuccess(fieldName) {
      const field = fields[fieldName];
      if (!field) return;

      field.element.classList.remove("is-invalid");
      field.element.classList.add("is-valid");

      if (field.errorElement) {
        field.errorElement.style.display = "none";
      }
      if (field.successElement) {
        field.successElement.style.display = "block";
      }
    }

    function clearFieldState(fieldName) {
      const field = fields[fieldName];
      if (!field) return;

      field.element.classList.remove("is-valid", "is-invalid");

      if (field.errorElement) {
        field.errorElement.style.display = "none";
      }
      if (field.successElement) {
        field.successElement.style.display = "none";
      }
    }

    function setLoading(isLoading) {
      const submitBtn = document.querySelector('button[type="submit"]');
      if (!submitBtn) return;

      if (isLoading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm me-2"></span>Registering...';
      } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-user-plus me-1"></i>Register';
      }
    }

    // Validation functions
    function validateUsername(value) {
      if (!value || value.length < 3) {
        return "Username must be at least 3 characters long.";
      }
      if (!/^[a-zA-Z0-9_]+$/.test(value)) {
        return "Username can only contain letters, numbers, and underscores.";
      }
      return "";
    }

    function validateEmail(value) {
      if (!value) {
        return "Email is required.";
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        return "Please enter a valid email address.";
      }
      return "";
    }

    function validatePassword(value) {
      if (!value || value.length < 8) {
        return "Password must be at least 8 characters long.";
      }
      if (!/[a-z]/.test(value)) {
        return "Password must contain at least one lowercase letter.";
      }
      if (!/[A-Z]/.test(value)) {
        return "Password must contain at least one uppercase letter.";
      }
      if (!/[0-9]/.test(value)) {
        return "Password must contain at least one number.";
      }
      if (!/[!@#$%^&*()_+\-=\[\]{};\':"\\|,.<>\/?]/.test(value)) {
        return "Password must contain at least one special character.";
      }
      return "";
    }

    function validateConfirmPassword(password, confirmPassword) {
      if (!confirmPassword) {
        return "Please confirm your password.";
      }
      if (password !== confirmPassword) {
        return "Passwords do not match.";
      }
      return "";
    }

    function validateName(value, fieldName) {
      if (!value || value.trim().length < 1) {
        return `${fieldName} is required.`;
      }
      if (!/^[a-zA-Z\s]+$/.test(value.trim())) {
        return `${fieldName} can only contain letters and spaces.`;
      }
      return "";
    }

    function validateDateOfBirth(value) {
      if (!value) {
        return "Date of birth is required.";
      }
      const today = new Date();
      const birthDate = new Date(value);
      const age = today.getFullYear() - birthDate.getFullYear();
      if (age < 0) {
        return "Date of birth cannot be in the future.";
      }
      if (age > 150) {
        return "Please enter a valid date of birth.";
      }
      return "";
    }

    function validatePhoneNumber(value) {
      if (!value) {
        return "Phone number is required.";
      }
      const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
      if (!phoneRegex.test(value.replace(/[-\s()]/g, ""))) {
        return "Please enter a valid phone number.";
      }
      return "";
    }

    function validateAddress(value) {
      if (!value || value.trim().length < 10) {
        return "Please provide a complete address (at least 10 characters).";
      }
      return "";
    }

    function validateCurrentLocation(value) {
      if (!value || value.trim().length < 2) {
        return "Current location must be at least 2 characters long.";
      }
      return "";
    }

    // Real-time validation
    Object.keys(fields).forEach((fieldName) => {
      const field = fields[fieldName];
      if (!field.element) return;

      field.element.addEventListener("blur", function () {
        const value = this.value.trim();
        let error = "";

        switch (fieldName) {
          case "username":
            error = validateUsername(value);
            break;
          case "email":
            error = validateEmail(value);
            break;
          case "password":
            error = validatePassword(value);
            break;
          case "first_name":
            error = validateName(value, "First name");
            break;
          case "last_name":
            error = validateName(value, "Last name");
            break;
          case "date_of_birth":
            error = validateDateOfBirth(value);
            break;
          case "phone_number":
            error = validatePhoneNumber(value);
            break;
          case "address":
            error = validateAddress(value);
            break;
          case "current_location":
            error = validateCurrentLocation(value);
            break;
        }

        if (error) {
          setFieldError(fieldName, error);
        } else if (value) {
          setFieldSuccess(fieldName);
        } else {
          clearFieldState(fieldName);
        }
      });

      field.element.addEventListener("input", function () {
        if (this.classList.contains("is-invalid")) {
          const value = this.value.trim();
          let error = "";

          switch (fieldName) {
            case "username":
              error = validateUsername(value);
              break;
            case "email":
              error = validateEmail(value);
              break;
            case "password":
              error = validatePassword(value);
              break;
            case "first_name":
              error = validateName(value, "First name");
              break;
            case "last_name":
              error = validateName(value, "Last name");
              break;
            case "date_of_birth":
              error = validateDateOfBirth(value);
              break;
            case "phone_number":
              error = validatePhoneNumber(value);
              break;
            case "address":
              error = validateAddress(value);
              break;
            case "current_location":
              error = validateCurrentLocation(value);
              break;
          }

          if (!error) {
            setFieldSuccess(fieldName);
          }
        }
      });
    });

    // Form submission validation
    const form = document.querySelector("form");
    const alertContainer =
      document.getElementById("alert-container") ||
      document.createElement("div");

    if (!document.getElementById("alert-container")) {
      alertContainer.id = "alert-container";
      form.parentNode.insertBefore(alertContainer, form);
    }

    form.addEventListener("submit", function (e) {
      let hasErrors = false;
      alertContainer.innerHTML = "";

      // Validate all fields
      const validations = [
        { field: "username", validator: (v) => validateUsername(v) },
        { field: "email", validator: (v) => validateEmail(v) },
        { field: "password", validator: (v) => validatePassword(v) },
        {
          field: "first_name",
          validator: (v) => validateName(v, "First name"),
        },
        { field: "last_name", validator: (v) => validateName(v, "Last name") },
        { field: "date_of_birth", validator: (v) => validateDateOfBirth(v) },
        { field: "phone_number", validator: (v) => validatePhoneNumber(v) },
        { field: "address", validator: (v) => validateAddress(v) },
        {
          field: "current_location",
          validator: (v) => validateCurrentLocation(v),
        },
      ];

      validations.forEach(({ field, validator }) => {
        const value = fields[field].element.value.trim();
        const error = validator(value);
        if (error) {
          setFieldError(field, error);
          hasErrors = true;
        }
      });

      // Validate confirm password
      const password = fields.password.element.value;
      const confirmPassword = fields.confirm_password.element.value;
      const confirmError = validateConfirmPassword(password, confirmPassword);
      if (confirmError) {
        setFieldError("confirm_password", confirmError);
        hasErrors = true;
      }

      // Validate consent
      const consentCheckbox = document.getElementById(
        "{{ form.consent_given.id_for_label }}"
      );
      if (consentCheckbox && !consentCheckbox.checked) {
        showAlert(
          "You must consent to data processing to register.",
          "warning"
        );
        hasErrors = true;
      }

      if (hasErrors) {
        e.preventDefault();
        showAlert(
          "Please correct the errors below before submitting.",
          "danger"
        );
        // Scroll to first error
        const firstError = document.querySelector(".is-invalid");
        if (firstError) {
          firstError.scrollIntoView({ behavior: "smooth", block: "center" });
        }
        return false;
      }

      // Show loading state
      setLoading(true);
    });

    // Geolocation functionality
    const btn = document.getElementById("get-location-btn");
    const addressEl = document.getElementById(
      "{{ form.address.id_for_label }}"
    );
    const locationEl = document.getElementById(
      "{{ form.current_location.id_for_label }}"
    );

    btn.addEventListener("click", function () {
      if (navigator.geolocation) {
        btn.textContent = "Getting location...";
        navigator.geolocation.getCurrentPosition(
          function (position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            // Reverse geocode
            fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
            )
              .then((response) => {
                if (!response.ok) {
                  throw new Error("Geocoding service unavailable");
                }
                return response.json();
              })
              .then((data) => {
                if (data && data.display_name) {
                  addressEl.value = data.display_name;
                  // Try to extract city/town from address details
                  let location = "";
                  if (data.address) {
                    location =
                      data.address.city ||
                      data.address.town ||
                      data.address.village ||
                      data.address.state ||
                      data.address.country ||
                      "";
                  }
                  locationEl.value = location;
                  btn.textContent = "Use Current Location";
                  // Trigger validation for the updated fields
                  if (addressEl.value) setFieldSuccess("address");
                  if (locationEl.value) setFieldSuccess("current_location");
                } else {
                  throw new Error("Unable to get address for this location");
                }
              })
              .catch((error) => {
                console.error("Geocoding error:", error);
                showAlert(
                  "Error getting address: " +
                    error.message +
                    ". Please enter your address manually.",
                  "danger"
                );
                btn.textContent = "Use Current Location";
              });
          },
          function (error) {
            console.error("Geolocation error:", error);
            let errorMessage = "Location access denied.";
            if (error.code === error.PERMISSION_DENIED) {
              errorMessage =
                "Location access denied. Please allow location access and try again.";
            } else if (error.code === error.POSITION_UNAVAILABLE) {
              errorMessage = "Location information is unavailable.";
            } else if (error.code === error.TIMEOUT) {
              errorMessage = "Location request timed out.";
            }
            showAlert(errorMessage, "warning");
            btn.textContent = "Use Current Location";
          }
        );
      } else {
        showAlert("Geolocation is not supported by this browser.", "warning");
      }
    });
  });
</script>
{% endblock %}
